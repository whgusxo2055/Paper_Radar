<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
  <head th:replace="~{layout :: head('Admin - Ingest - PAPER_RADAR')}"></head>
  <body>
    <header th:replace="~{layout :: header}"></header>
    <main class="container" th:attr="data-has-sources=${hasIngestSources}, data-running-count=${runningCount}">
      <div class="row">
        <h1>관리 / 수집(ingest)</h1>
      </div>
      <p class="muted">OpenAlex에서 논문 메타데이터를 가져와 Elasticsearch(works)에 저장합니다.</p>

      <section class="section">
        <div class="card">
          <h2 class="title">실행 안내</h2>
          <div class="muted" style="line-height: 1.6;">
            <div>1) 먼저 <a href="/admin/keywords">키워드</a> 또는 <a href="/admin/institutions">기관</a>을 <strong>최소 1개 이상 활성화</strong>하세요.</div>
            <div>2) 실행 버튼을 누르면 백그라운드에서 수집이 진행되고, 아래 “최근 실행 내역”에 결과가 표시됩니다.</div>
            <div>3) Full 수집은 <span th:text="${lookbackYears}">5</span>년치 범위로 오래 걸릴 수 있습니다(레이트 리밋/네트워크 상황에 따라 변동).</div>
          </div>

          <div class="row" style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border);">
            <div>현재 설정</div>
            <div class="muted" th:text="'활성 키워드 ' + ${enabledKeywordCount} + '개 · 활성 기관 ' + ${enabledInstitutionCount} + '개'">활성 키워드 0개 · 활성 기관 0개</div>
          </div>

          <div class="alert warn" th:if="${staleRunningCount != null and staleRunningCount > 0}" style="margin-top: 1rem;">
            <strong th:text="'30분 이상 실행 중인 job이 ' + ${staleRunningCount} + '건 있습니다.'">오래된 running job이 있습니다.</strong>
            <div class="muted">컨테이너 재시작/강제 종료로 인해 running 상태가 남아있을 수 있습니다.</div>
            <div class="muted">아래 “정리”를 누르면 일정 시간 이상 오래된 running job을 실패 처리로 마감합니다.</div>
            <div class="actions" style="margin-top: 0.5rem;">
              <button class="button secondary small"
                      type="button"
                      data-action="ingest-cleanup"
                      th:attr="data-minutes=${staleThresholdMinutes}">
                오래된 running 정리(<span th:text="${staleThresholdMinutes}">30</span>분)
              </button>
            </div>
          </div>

          <div class="alert warn" th:if="${!hasIngestSources}" style="margin-top: 1rem;">
            <strong>수집 대상이 없습니다.</strong>
            <div class="muted">활성 키워드/기관이 0개면 수집은 즉시 종료되며(0건), 정상 동작처럼 보일 수 있습니다.</div>
            <div class="muted">아래에서 먼저 설정을 추가한 뒤 다시 실행해 주세요.</div>
            <div class="actions" style="margin-top: 0.5rem;">
              <a class="button secondary small" href="/admin/keywords">키워드 설정</a>
              <a class="button secondary small" href="/admin/institutions">기관 설정</a>
            </div>
          </div>

          <div class="grid grid-2" style="margin-top: 1.5rem;">
            <div class="card" style="background-color: rgba(255,255,255,0.02);">
              <h3>증분 수집</h3>
              <p class="muted small">최근 업데이트된 데이터만 수집합니다.</p>
              <button class="button"
                      type="button"
                      data-action="ingest-run"
                      data-mode="incremental"
                      th:disabled="${!hasIngestSources}"
                      style="width: 100%;">
                증분 수집 실행
              </button>
            </div>

            <div class="card" style="background-color: rgba(255,255,255,0.02);">
              <h3>전체 수집</h3>
              <p class="muted small">지정된 기간의 데이터를 모두 수집합니다.</p>
              <div class="grid grid-2" style="margin-bottom: 1rem;">
                <div>
                  <label for="fullFrom" class="small">from</label>
                  <input id="fullFrom" type="date" th:value="${defaultFullFrom}" />
                </div>
                <div>
                  <label for="fullTo" class="small">to</label>
                  <input id="fullTo" type="date" th:value="${defaultFullTo}" />
                </div>
              </div>
              <button class="button secondary"
                      type="button"
                      data-action="ingest-run"
                      data-mode="full"
                      th:disabled="${!hasIngestSources}"
                      style="width: 100%;">
                전체 수집 실행
              </button>
            </div>
          </div>

          <div id="ingestMsg" class="alert hidden" style="margin-top: 1rem;"></div>
        </div>
      </section>

      <section class="section">
        <div class="row">
          <h2>최근 실행 내역</h2>
          <div class="muted" th:text="${#lists.size(jobs)} + '건'"></div>
          <button class="button secondary small" type="button" data-action="ingest-refresh">새로고침</button>
        </div>

        <div class="card" th:if="${jobs == null or #lists.isEmpty(jobs)}">
          <p class="muted">아직 실행 내역이 없습니다. 위 버튼으로 수집을 실행해 보세요.</p>
        </div>

        <div class="card table-scroll" th:if="${jobs != null and !#lists.isEmpty(jobs)}" style="padding: 0; overflow: hidden;">
          <div class="ingest-head" style="display: grid; grid-template-columns: 1fr 1fr 2fr 2fr 2fr 1fr 1fr 1fr 2fr; padding: 0.75rem 1rem; border-bottom: 1px solid var(--border); font-weight: 600; color: var(--text-muted); font-size: 0.875rem;">
            <div>모드</div>
            <div>상태</div>
            <div>시작</div>
            <div>종료</div>
            <div>진행</div>
            <div class="right">처리</div>
            <div class="right">신규</div>
            <div class="right">업데이트</div>
            <div>메시지</div>
          </div>
          <div class="ingest-row" th:each="j : ${jobs}" style="display: grid; grid-template-columns: 1fr 1fr 2fr 2fr 2fr 1fr 1fr 1fr 2fr; padding: 0.75rem 1rem; border-bottom: 1px solid var(--border);">
            <div th:text="${j.mode}">incremental</div>
            <div>
              <span class="badge"
                    th:classappend="${j.status} == 'success' ? ' success' : (${j.status} == 'failed' ? ' danger' : ' warn')"
                    th:text="${j.status}">success</span>
            </div>
            <div th:text="${@viewTimeFormat.format(j.startedAt)}">started</div>
            <div th:text="${@viewTimeFormat.format(j.endedAt)}">ended</div>
            <div class="muted small cell-wrap"
                 th:text="${@viewIngestJobFormat.progress(j)}"
                 th:attr="title=${@viewIngestJobFormat.progress(j)}">
              last=... · keyword:...
            </div>
            <div class="right" th:text="${j.processedCount}">0</div>
            <div class="right" th:text="${j.createdCount}">0</div>
            <div class="right" th:text="${j.updatedCount}">0</div>
            <div class="muted small cell-wrap" th:text="${j.errorSummary}" th:attr="title=${j.errorSummary}">message</div>
          </div>
        </div>
      </section>
    </main>
    <footer th:replace="~{layout :: footer}"></footer>
  </body>
</html>
